# FCM 개선기 2

이전에 FCM 전송에서 쓰레드 사용이 과다하게 발생하는 현상을 개선하였다. 이번에는 더 나아가서 설계를 개선 하였다.

시작하기 전 제한사항은 kafka를 사용하지 않는다. 많은 알림 시스템 개선 사항에서 kafka를 사용하지만 현재 운영 중인 서비스에서 kafka 사용은 오버엔지니어링이고,
회사에서 kafka를 운영할 만한 여력이 안된다. 그래서 순수하게 Java 만을 사용하여 개선할 예정이다.

고려사항을 알아보자.

### 고려사항
- 데이터 손실 방지 : 어떤 사황에서도 알림이 소실되면 안 된다. 알림이 지연되거나 순서가 틀려도 괜찮지만, 사라지면 안된다.
- 알림 중복 전송 방지
- 전송률 제한
- 재시도 방법

위 고려사항 중 전송률 제한은 구현하지 않겠다. 이유는 현재 개선기는 회사에서 고려한 사항인데 운영중인 서비스는 그만큼 트래픽 발생이 안되기 때문에 전송률 제한까지 고려하지 않아도 괜찮았다.
나머지 3가지 고려사항만 고려하여 개선하였다.

#### 데이터 손실 방지
메시지와 FCM 전송 성공 상태를 관리를 하나의 트랜잭션에서 관리하면 데이터 손실을 방지할 수 있다.

#### 알림 중복 전송 방지
FCM 전송을 하면 Firebase에서 전송 성공 여부에 대한 응답 code를 통해 알 수 있고, 이를 통해 알림 중복 전송을 제어할 수 있다.

#### 재시도 방법
Spring batch 또는 scheduler를 이용하여 재시도 처리를 합니다.

이제부터 코드를 통해 어떻게 개선 했는지 보겠다.


