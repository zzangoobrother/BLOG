# 10장 알림 시스템 설계

최근 많은 프로그램이 채택한 인기 있는 기능  
최신 뉴스, 제품 업데이트, 이벤트, 선물 등 고객에게 중요할 만한 정보를 비동기적으로 제공  
알림 시스템은 모바일 푸시 알림, SMS 메시지, 그리고 이메일 세 가지로 분류

### 1단계 문제 이해 및 설계 범위 확정

- 알림 종류 : 푸시 알림, SMS 메시지, 이메일
- 실시간 시스템 : 연성 실시간 시스템, 약간의 지연은 무방
- 단말 지원 : IOS, 안드로이드, 랩탑/데스크탑
- 알림 제공자 : 클라이언트 애플리케이션, 서버 측 스케줄링
- 사용자가 알림을 받지 않도록 설정 가능
- 천만 건 모바일 푸시 알림, 백만 건 SMS 메시지, 5백만 건 이메일

### 2단계 개략적 설계안 제시 및 동의 구하기

#### 알림 유형별 지원 방안

#### IOS 푸시 알림

![image_20250713_1.png](img/image_20250713_1.png)

- 알림 제공자 (provider) : 알림 요청을 만들어 알림 서비스로 보내는 주체
  - 단말 토큰 (device token) : 알림 요청을 보내는 데 필요한 고유 식별자
  - 페이로드 (payload) : 알림 내용을 담은 JSON 딕셔너리
  - APNS : 애플이 제공하는 원격 서비스

#### 안드로이드 푸시 알림

![image_20250713_2.png](img/image_20250713_2.png)

APNS 대신 FCM을 사용한다는 점만 다르다.

#### SMS 메시지

![image_20250713_3.png](img/image_20250713_3.png)

대부분 상용 서비스 이용

#### 이메일

![image_20250713_4.png](img/image_20250713_4.png)

대부분 이메일 서버를 구축할 역량은 갖추고 있다,

#### 연락처 정보 수집 절차

알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등 정보 필요  
해당 사용자의 정보를 수집하여 데이터베이스에 저장

#### 알림 전송 및 수신 절차

##### 개략적 설계안 - 초안

![image_20250713_5.png](img/image_20250713_5.png)

- 1부터 N까지의 서비스
  - 서비스는 마이크로서비스, 크론잡, 분산 시스템 컴포넌트일 수도 있음
  - 사용자에게 납기일을 알리는 과금 서비스, 배송 알림을 보내는 쇼핑몰 웹사이트 등
- 알림 시스템
  - 알림 시스템은 알림 전송/수신 처리의 핵심
  - 알림 전송을 위한 API 제공
  - 제3자 서비스에 전달항 알림 페이로드를 만들 수 있어야 함
- 제3자 서비스
  - 사용자에게 알림을 실제로 전달하는 역할
  - 유의할 점은 확장성
  - 쉡게 새로운 서비스를 통합하거나 기존 서비스를 제거할 수 있어야 함
- IOS, 안드로이드, SMS, 이메일 단말
  - 사용자는 자기 단말에서 알림 수신

이 설계에서 몇 가지 문제 존재

- SPOF : 알림 서비스 서버가 하나밖에 없어 장애가 생기면 전체 서비스에 장애 발생
- 규모 확장성 : 한 대 서비스로 알림에 관계된 모든 것을 처리하므로, 데이터베이스, 캐시 등 중요 컴포넌트 규모를 개별적으로 늘릴 방법 없음
- 성능 병목 : 모든 것을 한 서버로 처리하면 트래픽이 많이 몰리는 시간에 시스템이 과부하 상태 빠질 수 있음

##### 개략적 설계안 - 개선 버전

개선 방향

- 데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리
- 알림 서버를 증설, 자동으로 수평적 규모 확장이 이루어짐
- 메시지 큐를 이용, 시스템 컴포넌트 사이 강한 결합 끊음

![image_20250713_6.png](img/image_20250713_6.png)

- 1부터 N까지의 서비스 : 알림 시스템 서버의 API를 통해 알림을 보낼 서비스들
- 알림 서버
  - 알림 전송 API : 스팸 방지를 위해 보통 사내 서비스 또는 인증된 클라이언트만 이용 가능
  - 알림 검증 : 이메일 주소, 전화번호 등레 대한 기본적 검증 수행
  - 데이터베이스 또는 캐시 질의 : 알림에 포함시킬 데이터를 가져오는 기능
  - 알림 전송 : 알림 데이터를 메시지 큐에 넣음
- 캐시 : 사용자 정보, 단말 정보, 알림 템플릿 등을 캐시
- 데이터베이스 : 사용자, 알림, 설정 등 다양한 정보 저장
- 메시지 큐 : 시스템 컴포넌트 간 의존성 제거, 다량의 알림 전송시 버퍼 역할
- 작업 서버 : 메시지 큐에서 전송할 알림을 제3자 서비스로 전달하는 역할
- 제3자 서비스
- IOS, 안드로이드, SMS, 이메일

전송 순서

1. API를 호출하여 알림 서버로 보냄
2. 알림 서버는 사용자 정보, 단말 토큰, 알림 설정 같은 메타데이터를 캐시나 데이터베이스에서 가져옴
3. 알림 서버는 전송할 알림에 맞는 이벤트를 만들어 큐에 넣음
4. 작성 버서는 메시지 큐에서 알림 이벤트 가져옴
5. 작업 서버는 알림을 제3자 서비스로 보냄
6. 제3자 서비스는 사용자 단말로 알림 전송

### 3단계 살세 설계


