# 12장 채팅 시스템 설계

### 1단계 문제 이해 및 설계 범위 확정

- 1:1 채팅, 그룹 채팅 지원
- 모바인 앱, 웹 지원
- DAU 5천만
- 그룹 채팅일 경우 최대 100명 참가
- 사용자 접속 상태 표시 지원
- 메시지 길이 최대 100,000자 이하
- 채팅 이력 평생 저장
- 하나의 계정으로 여러 단말 동시 접속 지원
- 푸시 알림

### 2단계 개략적 설계안 제시 및 동의 구하기

채팅 시스템의 경우 클라이언트는 모바일 앱, 웹 애플리케이션  
클라이언트는 서로 직접 통신하지 않음

- 클라이언트들로부터 메시지 수신
- 메시지 수신자(recipient) 결정 및 전달
- 수신자가 접속 상태가 아닌 경우, 접속할 때까지 해당 메시지 보관

![image_20250721_1.png](img/image_20250721_1.png)

채팅 서비스의 경우 어떤 통신 프로토콜을 사용할 것인가 중요한 문제  
송신 클라이언트는 메시지를 채팅 서비스에 보낼 때, HTTP 프로토콜을 사용  
채팅 서비스와 접속에서 keep-alive 헤더를 사용하면 효율적, 클라이언트와 서버 사이의 연결을 끊지 않고 계속 유지 가능  
TCP 접속 과정에서 발생하는 샌드셰이크 횟수를 줄일 수 있음  
HTTP는 클라이언트가 연결을 만드는 프로토콜이며, 서버에서 클라이언트로 임의 시점에 메시지를 보내는 데는 어려움  
서버가 연결을 만드는 것처럼 동작 할 수 있도록 폴링, 롱 폴링, 웹소켓 기술 등 있음

#### 폴링

클라이언트가 주기적으로 서버에게 새 메시지 있냐고 물어보는 방법  
폴링을 자주하면 할수록 비용은 올라감  
메시지가 없는 경우 서버 자원 불필요하게 낭비

![image_20250721_2.png](img/image_20250721_2.png)

#### 롱 폴링

클라이언트는 새 메시지가 반환되거나 타임아웃 될 때까지 연결 유지  
클라이언트는 새 메시지를 받으면 기존 연결을 종료하고 서버에 새로운 요청을 보내어 모든 절차 다시 수행  
다음과 같은 약점 존재
- 메시지를 보내는 클라이언트와 수신하는 클라이언트가 같은 채팅 서버에 접속하게 되지 않을 수 있음
- 서버 입장에서 클라이언트가 연결을 해제했는지 아닌지 방법이 없다.
- 여전히 비효율적이다. 메시지를 많이 받지 않는 클라이언트는 타입아웃이 발생하면 주기적으로 다시 접속 함

![image_20250721_3.png](img/image_20250721_3.png)

#### 웹소켓

서버가 클라이언트에게 비동기 메시지를 보낼 때 가장 널리 사용  

![image_20250721_4.png](img/image_20250721_4.png)

- 웹 소켓 연결을 클라이언트가 시작
- 한번 맺어진 연결은 할구적이며 양방향
- 처음에는 HTTP 연결이지만 특정 핸드셰이크 절차를 거쳐 웹소켓 연결로 업그레이드
- 방화벽 있는 환경에서도 잘 동, 80, 443 처럼 HTTP, HTTPS 프로토콜이 사용하는 기본 포트번호 그대로 사용
- 서버 측에서 연결 관리를 효율적으로 해야 함

![image_20250721_5.png](img/image_20250721_5.png)

#### 개략적 설계안
