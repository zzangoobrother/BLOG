# 8장 URL 단축기 설계

긴 URL 입력시 Short URL 변환  
변환된 URL로 접속 시 본래 URL redirect

### 1단계 문제 이해 및 설계 번위 확정

- 쓰기 연산 : 매인 1억 개의 단축 URL 생성
- 초당 쓰기 연산 : 1억/24/3600 = 1160
- 읽기 연산 : 읽기 연산과 쓰기 연산 비율은 10:1 가정, 읽기 연산은 초당 11600회 발생
- URL 단축 서비스는 10년간 운영, 1억 * 365 * 10 = 3650억 개의 레코드 보관
- 축약 전 URL의 평균 길이는 100으로 가정
- 10년 동안 필요한 저장 용량 3650억 * 100 byte = 36.5TB

### 2단계 개략적 설계안 제시 및 동의 구하기

#### API 엔드포인트

1. URL 단축용 엔드포인트 : 새 단축 URL을 생성하고자 하는 클라이언트는 엔드포인트에 단축할 URL을 인자로 실어서 POST 요청  

POST /api/v1/data/shorten
- 인자 : {longUrl : longURLstirng}
- 반환 : 단축 URL

2. URL 디리렉션용 엔트포인트 : 단축 URL에 대해서 HTTP 요청이 오면 원래 URL로 보내주기 위한 용도의 엔트포인트

GET /api/v1/shortUrl
- 반환 : HTTP 리디렉션 목적지가 될 원래 URL

#### URL 리디렉션

![image_20250706_1.png](img/image_20250706_1.png)

단축 URL을 받은 서버는 그 URL을 원래 URL로 바꾸어 301 응답 Location 헤더로 반환한다.

![image_20250706_2.png](img/image_20250706_2.png)

- 301 Permanently Moved : 브라우저는 이 응답을 캐시한다. 추후 같은 단축 URL 요청을 보내면 캐시된 원래 URL로 요청을 보냄
- 302 Found : 일시적으로 Location 헤더가 지정하는 URL에 의해 처리, 단축 URL 서버에 먼저 보내진 후 원래 URL로 리디렉션

서버 부하를 줄이는 것이 중요하면 301를, 트래픽 분석이 중요하면 302가 유리

#### URL 단축

중요한 것은 긴 URL과 단축 URL을 대응시키는 해시 함수를 찾느 것

요구사항
- 입력으로 주어지는 긴 URL이 다른 값이면 해시 값도 달라야 함
- 계산된 해시 값은 원래 입력으로 주어졌던 긴 URL로 복원될 수 있어야 함

### 3단계 상세 설계

#### 데이터 모델

모든 것을 해시 테이블에 둠, 메모리 제한 발생  
<단축 URL, 원래 URL>

#### 해시 함수

원래 URL을 단축 URL로 변환하는데 사용

#### 해시 값 길이

hash value는 [0-9, a-z, A-Z] 문자로 구성  

![image_20250706_3.png](img/image_20250706_3.png)

개략적으로 계산했던 추정치 3650억 개의 URL을 만들어야 하기 때문에 62^n >= 3650억 으로 n은 7 이다.

#### 해시 후 충돌 해소

- 7글자 문자열 줄이는 쉬운 방법은 CRC32, MD5, SHA-1 등을 사용하여 해시를 생성 후 7글자로 자르는 방법
- 하지만 충돌 가능성이 높음
- 충돌이 발생하면 충돌이 해소될 때가지 사전에 정한 문자열을 해시값에 덧붙임

![image_20250706_4.png](img/image_20250706_4.png)

충돌 시 데이터베이스 조회 해야 하므로 오버헤드가 크다

#### base-62 변환

- 진법 변환(base conversion)은 URL 단축기를 구현할 때 흔히 사용
- 62진법 사용 이유는 문자 개수가 62개이기 때문
- 11157 -> 2TX 로 변환

#### 두 접근법 비교

| **해시 후 충돌 해소 전략**                                       | **base-62 변환**                                                              |
|---------------------------------------------------------|-----------------------------------------------------------------------------|
| 단축 URL의 길이가 고정됨                                         | 단축 URL의 길이가 가변적. ID 값이 커지면 같이 길어짐                                           |
| 유일성이 보장되는 ID 생성기가 필요치 않음                                | 유일성 보장 ID 생성기가 필요                                                           |
| 충돌이 가능해서 해소 전략이 필요                                      | ID의 유일성이 보장된 후에야 적용 가능한 전략이라 충돌은 아예 불가능                                     |
| ID로부터 단축 URL을 계산하는 방식이 아니라서 다음에 쓸 수 있는 URL을 알아내는 것이 불가능 | ID가 1씩 증가하는 값이라고 가정하면 다음에 쓸 수 있는 단축 URL이 무엇인지 쉽게 알아낼 수 있어서 보안상 문제가 될 소지가 있음 |

#### URL 단축기 상세 설계

![image_20250706_5.png](img/image_20250706_5.png)

1. 입력으로 긴 URL을 받는다.
2. 데이터베이스에 해당 URL이 있는지 검사
3. 데이터베이스에 있다면 해당 URL에 대한 단축 URL을 만든 적 있음,데이터베이스에서 단축 URL을 클라이언트에 반환
4. 데이터베이스에 없는 경우 유일한 ID 생성, 데이터베이스의 기본 키로 사용
5. 62진법 변환 적용, 단축 URL로 만듬
6. ID, 단축 URL, 원래 URL로 새 데이터베이스 레코드 만둔 후 단축 URL 클라이언트에 전달

#### URL 리디렉션 상세 설계

![image_20250706_6.png](img/image_20250706_6.png)

1. 사용자가 단축 URL 클릭
2. 로드밸런서가 해당 클릭으로 발생한 요청을 웹 서버에 전달
3. 단축 URL이 이미 캐시에 있는 경우 원래 URL을 클라이언트에 전달
4. 캐시에 해당 단축 URL이 없는 경우 데이터베이스에서 조회, 데이터베이스에 없다면 사용자가 잘못된 단축 URL을 입력
5. 데이터베이스에서 꺼낸 URL을 캐시에 넣은 후 사용자에 반환

### 4단계 마무리

추가적으로 고민 사항

- 처리율 제한 장치(rate limiter) : 요청이 밀려드면 무력화될 잠재적 보안 결함 존재, 처리율 제한 장치를 두면, IP 주소를 비롯한 필터링 규칙을 이용해 요청을 걸러낼 수 있음
- 웹 서버의 규모 확장 : 웹 계층은 무상태 계층이므로, 웹 서버를 자유로이 증설, 삭제 가능
- 데이터베이스의 규모 확장 : 다중화하거나 샤딩하여 규모 확장
- 데이터 분석 솔루션 : 데이터 분석 솔루션 통합해 두면 어떤 링크를 얼마나 많은 사용자가 클릭했는지, 언제 주로 클릭했는지 정보를 알 수 있음
- 가용성, 데이터 일관성, 안전성 : 대규모 시스템이 성공적으로 운영되기 위해 반드시 갖추어야 할 속성들
